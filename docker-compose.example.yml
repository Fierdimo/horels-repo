version: '3.8'

services:
  mysql:
    image: mariadb:10.11
    container_name: sw2-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: YOUR_ROOT_PASSWORD_HERE
      MYSQL_DATABASE: sw2_hotels
      MYSQL_USER: sw2user
      MYSQL_PASSWORD: YOUR_MYSQL_PASSWORD_HERE
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - sw2-network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: sw2-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - sw2-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --appendonly yes

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sw2-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: sw2_hotels
      DB_USER: sw2user
      DB_PASSWORD: YOUR_MYSQL_PASSWORD_HERE
      JWT_SECRET: YOUR_JWT_SECRET_HERE
      API_KEY: YOUR_API_KEY_HERE
      FRONTEND_URL: http://YOUR_SERVER_IP

      # Stripe Configuration
      STRIPE_SECRET_KEY: YOUR_STRIPE_SECRET_KEY
      STRIPE_WEBHOOK_SECRET: YOUR_STRIPE_WEBHOOK_SECRET
      STRIPE_PUBLISHABLE_KEY: YOUR_STRIPE_PUBLISHABLE_KEY
      STRIPE_RETURN_URL: http://YOUR_SERVER_IP/stripe-return
      STRIPE_VISA_TEST_CARD: "4242424242424242"
      USE_REAL_STRIPE: "true"

      # MEWS Configuration (demo/sandbox)
      USE_REAL_PMS: "true"
      TEST_USE_REAL_PMS: "true"
      PMS_PROVIDER: mews
      MEWS_CLIENT_ID: YOUR_MEWS_CLIENT_ID
      MEWS_CLIENT_SECRET: YOUR_MEWS_CLIENT_SECRET
      MEWS_TOKEN_URL: ""
      MEWS_BASE_URL: https://api.mews-demo.com
      MEWS_BOOKING_PATH: /connector/v1/reservations
      MEWS_AVAILABILITY_PATH: /connector/v1/availability
      MEWS_API_STYLE: connector_v1
      MEWS_WEBHOOK_SECRET: YOUR_MEWS_WEBHOOK_SECRET
      MEWS_WEBHOOK_SIGNATURE_HEADER: mews-signature

      # Legacy PMS variables
      PMS_API_KEY: YOUR_MEWS_CLIENT_ID
      PMS_API_URL: https://api.mews-demo.com

      # Redis
      USE_BULL: "true"
      REDIS_URL: redis://redis:6379

      # Security
      VALID_API_KEYS: key1,key2,key3
      PMS_ENCRYPTION_KEY: YOUR_PMS_ENCRYPTION_KEY_64_CHARS
      EXTRA_CHARGE_PERCENT: 5
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - sw2-network
    command: >
      sh -c "
        echo 'Waiting for MySQL...' &&
        sleep 10 &&
        npx sequelize-cli db:migrate &&
        npx sequelize-cli db:seed:all &&
        node dist/server.js
      "

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: http://YOUR_SERVER_IP/api
        VITE_STRIPE_PUBLISHABLE_KEY: YOUR_STRIPE_PUBLISHABLE_KEY
    container_name: sw2-frontend
    restart: unless-stopped
    networks:
      - sw2-network

  nginx:
    image: nginx:alpine
    container_name: sw2-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - sw2-network

volumes:
  mysql_data:
  redis_data:

networks:
  sw2-network:
    driver: bridge
